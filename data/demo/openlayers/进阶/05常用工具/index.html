<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenLayers Map</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol/ol.css" />
    <script src="https://cdn.jsdelivr.net/npm/ol/dist/ol.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
      }

      body {
        width: 100%;
        height: 100vh;
      }

      #map {
        width: 100%;
        height: 100%;
      }

      .ol-control button {
        background-color: #1890ff;
        border: none;
        color: white;
        padding: 8px;
        border-radius: 4px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .ol-control button:hover {
        background-color: #40a9ff;
      }

      .tool-controls {
        top: 50%;
        right: 0.5em;
        left: auto;
        transform: translateY(-50%);
        background: white;
        padding: 5px;
        border-radius: 4px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      .tool-controls button {
        display: block;
        float: none;
        margin: 5px;
        min-width: 40px;
        height: 40px;
        font-size: 14px;
      }

      .tool-controls .cancel-draw-btn {
        background-color: #ff4d4f;
        margin-top: 10px;
      }

      .tool-controls .cancel-draw-btn:hover {
        background-color: #ff7875;
      }

      .reset-extent {
        top: 50%;
        left: 0.5em;
        transform: translateY(-50%);
      }

      .reset-extent button {
        font-size: 18px;
        width: 40px;
        height: 40px;
      }

      .icon {
        width: 24px;
        height: 24px;
        fill: currentColor;
      }

      .selection-box {
        border: 2px solid #2196f3;
        background: rgba(33, 150, 243, 0.1);
        position: absolute;
        pointer-events: none;
        border-radius: 4px;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
        animation: pulse 2s infinite;
        z-index: 1000;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.4);
        }
        70% {
          box-shadow: 0 0 0 6px rgba(33, 150, 243, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(33, 150, 243, 0);
        }
      }

      .tooltip {
        position: fixed;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
        z-index: 1001;
        display: none;
      }

      .selection-info {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 14px;
        display: none;
        z-index: 1001;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <div class="tooltip"></div>
    <div class="selection-info"></div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // åˆ›å»ºåœ°å›¾
        const map = new ol.Map({
          target: "map",
          view: new ol.View({
            center: ol.proj.fromLonLat([117.33083, 39.094899]), // å¤©æ´¥
            zoom: 4,
          }),
        });
        // TODO
        window.map = map;

        // æ·»åŠ å¤©åœ°å›¾å›¾å±‚
        const tdtLayer = new ol.layer.Tile({
          source: new ol.source.XYZ({
            url: "http://t0.tianditu.gov.cn/vec_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=d32c6748c80f81a44acd8633cea41dfd",
            crossOrigin: "anonymous",
          }),
        });
        map.addLayer(tdtLayer);

        // ä¿å­˜åˆå§‹èŒƒå›´
        const initialExtent = map.getView().calculateExtent(map.getSize());

        // åˆ›å»ºç»˜å›¾å›¾å±‚
        const source = new ol.source.Vector();
        const vector = new ol.layer.Vector({
          source: source,
          style: new ol.style.Style({
            fill: new ol.style.Fill({
              color: "rgba(24, 144, 255, 0.2)",
            }),
            stroke: new ol.style.Stroke({
              color: "#1890ff",
              width: 2,
            }),
            image: new ol.style.Circle({
              radius: 7,
              fill: new ol.style.Fill({
                color: "#1890ff",
              }),
            }),
          }),
        });
        map.addLayer(vector);

        // åˆ›å»ºç»˜å›¾å·¥å…·
        let draw;
        const addInteraction = function (type) {
          if (draw) {
            map.removeInteraction(draw);
          }
          draw = new ol.interaction.Draw({
            source: source,
            type: type,
          });
          map.addInteraction(draw);
        };

        // åˆ›å»ºç¼–è¾‘å·¥å…·
        const modify = new ol.interaction.Modify({ source: source });
        map.addInteraction(modify);

        // åˆ›å»ºåˆ é™¤å·¥å…·
        const snap = new ol.interaction.Snap({ source: source });
        map.addInteraction(snap);

        // æ·»åŠ å·¥å…·æ§ä»¶
        const toolControls = document.createElement("div");
        toolControls.className = "ol-control tool-controls";

        // å®šä¹‰å·¥å…·å›¾æ ‡
        const icons = {
          Point:
            '<svg class="icon" viewBox="0 0 1024 1024"><path d="M512 85.333333c-164.949333 0-298.666667 133.738667-298.666667 298.666667 0 224 298.666667 554.666667 298.666667 554.666667s298.666667-330.666667 298.666667-554.666667c0-164.928-133.717333-298.666667-298.666667-298.666667z m0 448a149.333333 149.333333 0 1 1 0-298.666666 149.333333 149.333333 0 0 1 0 298.666666z"/></svg>',
          LineString:
            '<svg class="icon" viewBox="0 0 1024 1024"><path d="M904.533333 119.466667L119.466667 904.533333l42.666666 42.666667 785.066667-785.066667z"/></svg>',
          Polygon:
            '<svg class="icon" viewBox="0 0 1024 1024"><path d="M834.56 955.733333H189.44c-66.56 0-121.173333-54.613333-121.173333-121.173333V189.44c0-66.56 54.613333-121.173333 121.173333-121.173333h645.12c66.56 0 121.173333 54.613333 121.173333 121.173333v645.12c0 66.56-54.613333 121.173333-121.173333 121.173333z"/></svg>',
          Circle:
            '<svg class="icon" viewBox="0 0 1024 1024"><path d="M512 85.333333c-235.648 0-426.666667 191.018667-426.666667 426.666667s191.018667 426.666667 426.666667 426.666667 426.666667-191.018667 426.666667-426.666667-191.018667-426.666667-426.666667-426.666667z"/></svg>',
          MeasureLength:
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12h20M6 8v8M12 6v12M18 8v8"/></svg>',
          MeasureArea:
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3z"/><path d="M3 9h18M3 15h18M9 3v18M15 3v18"/></svg>',
          fullScreenshot:
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 15v4a2 2 0 002 2h14a2 2 0 002-2v-4M17 9l-5 5-5-5M12 12.8V2.5"/></svg>',
          areaScreenshot:
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3v3a2 2 0 01-2 2H3m18 0h-3a2 2 0 01-2-2V3m0 18v-3a2 2 0 012-2h3M3 16h3a2 2 0 012 2v3"/></svg>',
        };

        const drawTypes = [
          "Point",
          "LineString",
          "Polygon",
          "Circle",
          "MeasureLength",
          "MeasureArea",
          "fullScreenshot",
          "areaScreenshot",
        ];
        drawTypes.forEach((type) => {
          const button = document.createElement("button");
          button.innerHTML = icons[type];
          button.title = type;
          button.id = type;

          button.addEventListener("click", () => {
            if (type === "MeasureLength" || type === "MeasureArea") {
              // å¤„ç†æµ‹é‡å·¥å…·
              if (type === "MeasureLength") {
                addMeasurementInteraction("LineString");
              } else {
                addMeasurementInteraction("Polygon");
              }
            } else if (type === "fullScreenshot" || type === "areaScreenshot") {
            } else {
              // å¤„ç†æ™®é€šç»˜å›¾å·¥å…·
              addInteraction(type);
            }
          });
          toolControls.appendChild(button);
        });

        // æ·»åŠ æ¸…é™¤æŒ‰é’®
        const clearButton = document.createElement("button");
        clearButton.innerHTML =
          '<svg class="icon" viewBox="0 0 1024 1024"><path d="M899.1 869.6l-53-305.6H864c14.4 0 26-11.6 26-26V346c0-14.4-11.6-26-26-26H618V138c0-14.4-11.6-26-26-26H432c-14.4 0-26 11.6-26 26v182H160c-14.4 0-26 11.6-26 26v192c0 14.4 11.6 26 26 26h17.9l-53 305.6c-0.3 1.5-0.4 3-0.4 4.4 0 14.4 11.6 26 26 26h723c1.5 0 3-0.1 4.4-0.4 14.2-2.4 23.7-15.9 21.2-30zM204 390h272V182h72v208h272v104H204V390z m468 440V674c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v156H416V674c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v156H202.8l45.1-260H776l45.1 260H672z"/></svg>';
        clearButton.title = "æ¸…é™¤";
        clearButton.addEventListener("click", () => {
          // æ¸…é™¤æ‰€æœ‰å›¾å½¢
          source.clear();
          // æ¸…é™¤æ‰€æœ‰æµ‹é‡è¦†ç›–ç‰©
          const overlays = map.getOverlays().getArray().slice();
          overlays.forEach((overlay) => {
            const element = overlay.getElement();
            if (
              element &&
              element.className &&
              element.className.indexOf("ol-tooltip-measure") !== -1
            ) {
              map.removeOverlay(overlay);
            }
          });
        });
        toolControls.appendChild(clearButton);

        // æ·»åŠ å–æ¶ˆç»˜åˆ¶æŒ‰é’®
        const cancelButton = document.createElement("button");
        cancelButton.className = "cancel-draw-btn";
        cancelButton.innerHTML =
          '<svg class="icon" viewBox="0 0 1024 1024"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64z m165.4 618.2l-66-0.3L512 563.4l-99.3 118.4-66.1 0.3c-4.4 0-8-3.5-8-8 0-1.9 0.7-3.7 1.9-5.2l130.1-155L340.5 359c-1.2-1.5-1.9-3.3-1.9-5.2 0-4.4 3.6-8 8-8l66.1 0.3L512 464.6l99.3-118.4 66-0.3c4.4 0 8 3.5 8 8 0 1.9-0.7 3.7-1.9 5.2L553.5 514l130 155c1.2 1.5 1.9 3.3 1.9 5.2 0 4.4-3.6 8-8 8z"/></svg>';
        // cancelButton.title = "å–æ¶ˆç»˜åˆ¶";
        cancelButton.addEventListener("click", () => {
          if (draw) {
            map.removeInteraction(draw);
            draw = null;
          }
        });
        toolControls.appendChild(cancelButton);

        // æ·»åŠ é‡ç½®èŒƒå›´æŒ‰é’®
        const resetControl = document.createElement("div");
        resetControl.className = "ol-control reset-extent";
        const resetButton = document.createElement("button");
        resetButton.innerHTML =
          '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 1024 1024"><path fill="currentColor" d="M784.512 230.272v-50.56a32 32 0 1 1 64 0v149.056a32 32 0 0 1-32 32H667.52a32 32 0 1 1 0-64h92.992A320 320 0 1 0 524.8 833.152a320 320 0 0 0 320-320h64a384 384 0 0 1-384 384a384 384 0 0 1-384-384a384 384 0 0 1 643.712-282.88"/></svg>';
        // resetButton.title = "é‡ç½®èŒƒå›´";
        resetButton.addEventListener("click", () => {
          map.getView().fit(initialExtent, {
            duration: 1000,
          });
        });
        resetControl.appendChild(resetButton);

        map.addControl(
          new ol.control.Control({
            element: toolControls,
          })
        );
        map.addControl(
          new ol.control.Control({
            element: resetControl,
          })
        );

        // æ·»åŠ æµ‹é‡å·¥å…·ç›¸å…³å‡½æ•°
        let measureTooltipElement;
        let measureTooltip;
        let sketch;
        let measureOverlays = [];

        const formatLength = function (line) {
          const length = ol.sphere.getLength(line);
          let output;
          if (length > 100) {
            output = Math.round((length / 1000) * 100) / 100 + " km";
          } else {
            output = Math.round(length * 100) / 100 + " m";
          }
          return output;
        };

        const formatArea = function (polygon) {
          const area = ol.sphere.getArea(polygon);
          let output;
          if (area > 10000) {
            output = Math.round((area / 1000000) * 100) / 100 + " kmÂ²";
          } else {
            output = Math.round(area * 100) / 100 + " mÂ²";
          }
          return output;
        };

        function addMeasurementInteraction(type) {
          if (draw) {
            map.removeInteraction(draw);
          }
          draw = new ol.interaction.Draw({
            source: source,
            type: type,
            style: new ol.style.Style({
              fill: new ol.style.Fill({
                color: "rgba(24, 144, 255, 0.2)",
              }),
              stroke: new ol.style.Stroke({
                color: "#1890ff",
                lineDash: [6, 6],
                width: 2,
              }),
              image: new ol.style.Circle({
                radius: 5,
                stroke: new ol.style.Stroke({
                  color: "#1890ff",
                }),
                fill: new ol.style.Fill({
                  color: "#fff",
                }),
              }),
            }),
          });
          map.addInteraction(draw);

          draw.on("drawstart", function (evt) {
            sketch = evt.feature;
            let tooltipCoord = evt.coordinate;
            createMeasureTooltip();

            sketch.getGeometry().on("change", function (evt) {
              const geom = evt.target;
              let output;
              if (geom instanceof ol.geom.Polygon) {
                output = formatArea(geom);
                tooltipCoord = geom.getInteriorPoint().getCoordinates();
              } else if (geom instanceof ol.geom.LineString) {
                output = formatLength(geom);
                tooltipCoord = geom.getLastCoordinate();
              }
              measureTooltipElement.innerHTML = output;
              measureTooltip.setPosition(tooltipCoord);
            });
          });

          draw.on("drawend", function () {
            measureTooltipElement.className =
              "ol-tooltip ol-tooltip-static ol-tooltip-measure";
            measureTooltip.setOffset([0, -7]);
            // ä¿å­˜å½“å‰æµ‹é‡è¦†ç›–ç‰©çš„å¼•ç”¨
            measureOverlays.push(measureTooltip);
            sketch = null;
            measureTooltipElement = null;
            createMeasureTooltip();
          });
        }

        function createMeasureTooltip() {
          if (measureTooltipElement) {
            measureTooltipElement.parentNode.removeChild(measureTooltipElement);
          }
          measureTooltipElement = document.createElement("div");
          measureTooltipElement.className = "ol-tooltip ol-tooltip-measure";
          measureTooltip = new ol.Overlay({
            element: measureTooltipElement,
            offset: [0, -15],
            positioning: "bottom-center",
          });
          map.addOverlay(measureTooltip);
        }

        //

        const tooltip = document.querySelector(".tooltip");
        const selectionInfo = document.querySelector(".selection-info");

        // å…¨å›¾æˆªå›¾
        const fullScreenshotBtn = document.getElementById("fullScreenshot");
        fullScreenshotBtn.addEventListener("click", async function () {
          this.disabled = true;
          this.style.background = "linear-gradient(145deg, #4CAF50, #388E3C)";
          this.textContent = "ğŸ“¸";

          try {
            const canvas = await html2canvas(document.querySelector("#map"), {
              allowTaint: false,
              useCORS: true,
            });
            const link = document.createElement("a");
            link.download = `åœ°å›¾å…¨å›¾æˆªå›¾_${new Date().toLocaleString()}.png`;
            link.href = canvas.toDataURL();
            link.click();
          } catch (error) {
            alert("æˆªå›¾å¤±è´¥ï¼Œè¯·é‡è¯•");
          } finally {
            this.disabled = false;
            this.style.background = "";
            this.innerHTML = icons["fullScreenshot"];
          }
        });

        // æ¡†é€‰æˆªå›¾
        let isSelecting = false;
        let startPoint;
        let selectionBox;
        let dragBox;

        const areaScreenshotBtn = document.getElementById("areaScreenshot");
        areaScreenshotBtn.addEventListener("click", function () {
          if (isSelecting) {
            // å–æ¶ˆæ¡†é€‰æ¨¡å¼
            cancelSelection();
            return;
          }

          // å¼€å¯æ¡†é€‰æ¨¡å¼
          isSelecting = true;
          this.classList.add("active");
          this.textContent = "âŒ";
          map.getTargetElement().style.cursor = "crosshair";
          tooltip.style.display = "block";
          tooltip.textContent = "æŒ‰ä½é¼ æ ‡å·¦é”®æ‹–åŠ¨é€‰æ‹©åŒºåŸŸï¼ŒESCå–æ¶ˆ";

          // æ·»åŠ æ¡†é€‰äº¤äº’
          dragBox = new ol.interaction.DragBox({
            className: "selection-box",
          });
          map.addInteraction(dragBox);

          dragBox.on("boxend", async function () {
            const extent = dragBox.getGeometry().getExtent();
            const bottomLeft = map.getPixelFromCoordinate([
              extent[0],
              extent[1],
            ]);
            const topRight = map.getPixelFromCoordinate([extent[2], extent[3]]);

            const bounds = {
              left: bottomLeft[0],
              top: topRight[1],
              width: topRight[0] - bottomLeft[0],
              height: bottomLeft[1] - topRight[1],
            };

            if (bounds.width < 50 || bounds.height < 50) {
              selectionInfo.textContent =
                "é€‰åŒºå¤ªå°ï¼Œè¯·é‡æ–°é€‰æ‹©(æœ€å° 50Ã—50 åƒç´ )";
              selectionInfo.style.display = "block";
              return;
            }

            try {
              selectionInfo.textContent = "æ­£åœ¨ç”Ÿæˆæˆªå›¾...";
              selectionInfo.style.display = "block";

              const canvas = await html2canvas(document.querySelector("#map"), {
                x: bounds.left,
                y: bounds.top,
                width: bounds.width,
                height: bounds.height,
                allowTaint: false,
                useCORS: true,
              });

              const link = document.createElement("a");
              link.download = `åœ°å›¾åŒºåŸŸæˆªå›¾_${new Date().toLocaleString()}.png`;
              link.href = canvas.toDataURL();
              link.click();

              cancelSelection();
            } catch (error) {
              selectionInfo.textContent = "æˆªå›¾å¤±è´¥ï¼Œè¯·é‡è¯•";
              setTimeout(cancelSelection, 2000);
            }
          });

          dragBox.on("boxdrag", function () {
            const extent = dragBox.getGeometry().getExtent();
            const bottomLeft = map.getPixelFromCoordinate([
              extent[0],
              extent[1],
            ]);
            const topRight = map.getPixelFromCoordinate([extent[2], extent[3]]);

            const width = Math.abs(topRight[0] - bottomLeft[0]);
            const height = Math.abs(bottomLeft[1] - topRight[1]);

            selectionInfo.style.display = "block";
            selectionInfo.textContent = `é€‰åŒºå¤§å°: ${width.toFixed(
              0
            )} Ã— ${height.toFixed(0)} åƒç´ `;
          });
        });

        // ESCé”®å–æ¶ˆæ¡†é€‰
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape" && isSelecting) {
            cancelSelection();
          }
        });

        function cancelSelection() {
          isSelecting = false;
          map.getTargetElement().style.cursor = "";
          areaScreenshotBtn.classList.remove("active");
          areaScreenshotBtn.textContent = "âœ‚ï¸";
          tooltip.style.display = "none";
          selectionInfo.style.display = "none";
          if (dragBox) {
            map.removeInteraction(dragBox);
            dragBox = null;
          }
        }

        // æ›´æ–°æç¤ºæ¡†ä½ç½®
        map.on("pointermove", function (e) {
          if (!isSelecting) return;
          tooltip.style.left = e.originalEvent.pageX + 10 + "px";
          tooltip.style.top = e.originalEvent.pageY + 10 + "px";
        });
      });
    </script>
  </body>
</html>
